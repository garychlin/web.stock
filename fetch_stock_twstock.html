<?php
// 確保從 GET 請求中獲取股票代號
$stock_code = isset($_GET['stockCode']) ? $_GET['stockCode'] : '2330'; // 默認為台積電的股票代號

// 使用完整的 Python 路徑調用腳本
$command = escapeshellcmd("/usr/local/bin/python /Users/garylin/Projects-Cursor/stock/fetch_stock_twstock.py {$stock_code}"); // 使用 python 調用腳本
$output = shell_exec($command); // 執行命令並獲取輸出

if ($output === null) {
    die("無法執行 Python 腳本");
}

// 處理返回的數據
$data = json_decode($output, true); // 將 JSON 解析為 PHP 陣列
if ($data) {
    echo "<h2>股票代號: " . htmlspecialchars($data['stock_code']) . "</h2>";
    
    // 檢查價格是否為空
    if (!empty($data['price'])) {
        // 顯示最新的股價
        $latest_price = end($data['price']); // 獲取最新的價格
        echo "<h3>最新股價: " . htmlspecialchars($latest_price) . "</h3>";
        
        // 顯示所有價格
        echo "<h4>歷史股價:</h4>";
        echo "<ul>";
        foreach ($data['price'] as $price) {
            echo "<li>" . htmlspecialchars($price) . "</li>";
        }
        echo "</ul>";
    } else {
        echo "<h3>無法獲取股價資料</h3>";
    }
} else {
    echo "<h3>無法獲取數據</h3>";
}
?>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div>
    <canvas id="priceChart" width="400" height="200"></canvas>
</div>

<script>
    const ctx = document.getElementById('priceChart').getContext('2d');
    const prices = <?php echo json_encode($data['price']); ?>; // 将价格数据传递给 JavaScript
    const labels = prices.map((_, index) => index + 1); // 创建标签

    const priceChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: '股價',
                data: prices,
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 2,
                fill: false
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
</script>
