<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台灣證券交易所股票查詢</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        /* 表格行 hover 效果 */
        .table-hover tbody tr:hover {
            background-color: rgba(75, 192, 192, 0.2); /* 淺色背景 */
        }
        .text-red {
            color: red; /* 漲的顏色 */
            font-weight: bold; /* 粗體 */
        }
        .text-green {
            color: green; /* 跌的顏色 */
            font-weight: bold; /* 粗體 */
        }
        .price-cell {
            font-weight: bold; /* 收盤價粗體 */
        }
    </style>
</head>
<body>
    <?php include 'navigator.html'; ?>

    <div class="container mt-5">
        <h1>股票查詢</h1>
        <div class="form-row mb-3">
            <div class="col">
                <label for="stockCodeInput">股票代號：</label>
                <input type="text" id="stockCodeInput" class="form-control" placeholder="請輸入股票代號" value="2330">
            </div>
            <div class="col">
                <label for="yearSelect">日期：</label>
                <select id="yearSelect" class="form-control">
                    <script>
                        const currentYear = new Date().getFullYear();
                        for (let year = 2010; year <= currentYear; year++) {
                            document.write(`<option value="${year}" ${year === currentYear ? 'selected' : ''}>${year}</option>`);
                        }
                    </script>
                </select>
            </div>
            <div class="col">
                <label for="monthSelect">月份：</label>
                <select id="monthSelect" class="form-control">
                    <script>
                        const currentMonth = new Date().getMonth() + 1; // 獲取當前月份
                        for (let month = 1; month <= 12; month++) {
                            document.write(`<option value="${month}" ${month === currentMonth ? 'selected' : ''}>${month}</option>`);
                        }
                    </script>
                </select>
            </div>
            <div class="col">
                <label>&nbsp;</label> <!-- 空白標籤以保持格式 -->
                <button id="searchButton" class="btn btn-primary btn-block">查詢</button>
            </div>
        </div>

        <div id="title"></div> <!-- 新增標題區域 -->
        <div id="result"></div> <!-- 價格表格在這裡 -->

        <canvas id="candlestickChart" width="400" height="200"></canvas> <!-- K 線圖在下 -->
        <canvas id="priceChart" width="400" height="200"></canvas> <!-- 股價圖在下 -->
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

    <script>
        $(document).ready(function() {
            let candlestickChart;
            let priceChart;

            const urlParams = new URLSearchParams(window.location.search);
            const stockCode = urlParams.get('stockCode') || '2330';
            $('#stockCodeInput').val(stockCode);

            $('#searchButton').click(function() {
                const stockCode = $('#stockCodeInput').val();
                const year = $('#yearSelect').val();
                const month = String($('#monthSelect').val()).padStart(2, '0');
                const apiUrl = `https://www.twse.com.tw/exchangeReport/STOCK_DAY?response=json&date=${year}${month}01&stockNo=${stockCode}`;
                fetchData(apiUrl, year, month, stockCode); // 傳遞 year 和 month
            });

            function fetchData(apiUrl, year, month, stockCode) {
                $.ajax({
                    url: apiUrl,
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        console.log(data); // 調試信息，查看獲取的數據
                        if (data.stat === "OK") {
                            displayData(data.data, data.title, year, month, stockCode); // 傳遞 data.title
                        } else {
                            $('#result').html(`<h3>錯誤: ${data.stat}</h3>`);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('AJAX Error:', error); // 調試信息，查看錯誤
                        $('#result').html(`<h3>無法獲取數據: ${error}</h3>`);
                    }
                });
            }

            function displayData(stockData, apiTitle, year, month, stockCode) {
                $('#result').empty();
                $('#title').empty(); // 清空標題區域

                // 獲取 API 返回的標題
                const titleParts = apiTitle.split(' '); // 分割標題以獲取年份和股票名稱
                const stockName = titleParts[2]; // 假設股票名稱在第三個位置
                const yearInRepublic = parseInt(titleParts[0]); // 獲取民國年
                const westernYear = yearInRepublic + 1911; // 轉換為西元年
                $('#title').append(`<h2>${westernYear} 年 ${month} 月 ${stockCode} ${stockName} 各日成交資訊</h2>`); // 新增標題

                let tableHtml = `
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>日期</th>
                                <th>成交股數</th>
                                <th>成交金額</th>
                                <th>成交筆數</th>
                                <th>開盤價</th>
                                <th>最高價</th>
                                <th>最低價</th>
                                <th>漲跌價差</th>
                                <th>收盤價</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                const candlestickData = [];
                const prices = [];
                const labels = [];

                stockData.forEach(stock => {
                    const dateParts = stock[0].split('/');
                    const year = parseInt(dateParts[0]) + 1911;
                    const formattedDate = new Date(`${year}-${dateParts[1]}-${dateParts[2]}`).getTime();
                    const openingPrice = parseFloat(stock[3].replace(/,/g, ''));
                    const closingPrice = parseFloat(stock[6].replace(/,/g, ''));
                    const highestPrice = parseFloat(stock[4].replace(/,/g, ''));
                    const lowestPrice = parseFloat(stock[5].replace(/,/g, ''));
                    const priceDifference = stock[7];

                    tableHtml += `
                        <tr>
                            <td>${year}-${dateParts[1]}-${dateParts[2]}</td>
                            <td>${stock[1]}</td> <!-- 成交股數 -->
                            <td>${stock[2]}</td> <!-- 成交金額 -->
                            <td>${stock[3]}</td> <!-- 成交筆數 -->
                            <td>${openingPrice}</td> <!-- 開盤價 -->
                            <td>${highestPrice}</td> <!-- 最高價 -->
                            <td>${lowestPrice}</td> <!-- 最低價 -->
                            <td class="${priceDifference > 0 ? 'text-red' : (priceDifference < 0 ? 'text-green' : '')}">${priceDifference}</td> <!-- 漲跌價差 -->
                            <td class="${closingPrice > openingPrice ? 'text-red' : 'text-green'} price-cell">${closingPrice}</td> <!-- 收盤價 -->
                        </tr>
                    `;

                    candlestickData.push({
                        x: formattedDate,
                        o: openingPrice,
                        h: highestPrice,
                        l: lowestPrice,
                        c: closingPrice
                    });

                    prices.push(closingPrice);
                    labels.push(`${year}-${dateParts[1]}-${dateParts[2]}`);
                });

                tableHtml += `
                        </tbody>
                    </table>
                `;
                $('#result').append(tableHtml);

                const ctxCandlestick = document.getElementById('candlestickChart').getContext('2d');
                if (candlestickChart) {
                    candlestickChart.destroy();
                }
                candlestickChart = new Chart(ctxCandlestick, {
                    type: 'candlestick',
                    data: {
                        datasets: [{
                            label: 'K 線圖',
                            data: candlestickData,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1,
                            backgroundColor: (context) => {
                                const value = context.dataset.data[context.dataIndex];
                                return value.c > value.o ? 'rgba(75, 192, 192, 1)' : 'rgba(255, 99, 132, 1)';
                            }
                        }]
                    },
                    options: {
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'day'
                                },
                                title: {
                                    display: true,
                                    text: '日期'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: '價格'
                                }
                            }
                        }
                    }
                });

                const ctxPrice = document.getElementById('priceChart').getContext('2d');
                if (priceChart) {
                    priceChart.destroy();
                }
                priceChart = new Chart(ctxPrice, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '收盤價',
                            data: prices,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 2,
                            fill: false
                        }]
                    },
                    options: {
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'day'
                                },
                                title: {
                                    display: true,
                                    text: '日期'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: '價格'
                                }
                            }
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>