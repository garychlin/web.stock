<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>維持率計算</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        /* 自定义样式 */
        .modal-body {
            text-align: center;
        }
        /* 设置链接颜色为黑色 */
        a {
            color: black; /* 设置链接颜色为黑色 */
            text-decoration: none; /* 可选：去掉下划线 */
        }
        a:hover {
            text-decoration: underline; /* 可选：鼠标悬停时显示下划线 */
        }
    </style>
</head>
<body>
    <?php include 'navigator.html'; ?>
    <div class="container mt-5">
        <h1>股票維持率計算</h1>
        
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th>股票</th>
                    <th>代號</th>
                    <th>狀態</th>
                    <th id="priceHeader">股價</th>
                    <th>股數</th>
                    <th>市值</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><a href="fetch_stock_twstock.html?stockCode=3661" target="_blank">世芯 KY</a></td>
                    <td><a href="fetch_stock_twstock.html?stockCode=3661" target="_blank">3661</a></td>
                    <td>0905 質借中</td>
                    <td class="price-cell" data-code="3661"></td>
                    <td>2000</td>
                    <td class="market-value" data-code="3661"></td>
                </tr>
                <tr>
                    <td><a href="fetch_stock_twstock.html?stockCode=6531" target="_blank">愛普</a></td>
                    <td><a href="fetch_stock_twstock.html?stockCode=6531" target="_blank">6531</a></td>
                    <td>0905 質借中</td>
                    <td class="price-cell" data-code="6531"></td>
                    <td>4000</td>
                    <td class="market-value" data-code="6531"></td>
                </tr>
                <tr>
                    <td><a href="fetch_stock_twstock.html?stockCode=3548" target="_blank">兆利</a></td>
                    <td><a href="fetch_stock_twstock.html?stockCode=3548" target="_blank">3548</a></td>
                    <td>0905 質借中</td>
                    <td class="price-cell" data-code="3548"></td>
                    <td>4000</td>
                    <td class="market-value" data-code="3548"></td>
                </tr>
                <tr>
                    <td><a href="fetch_stock_twstock.html?stockCode=3406" target="_blank">玉晶光</a></td>
                    <td><a href="fetch_stock_twstock.html?stockCode=3406" target="_blank">3406</a></td>
                    <td>0905 質借中</td>
                    <td class="price-cell" data-code="3406"></td>
                    <td>2000</td>
                    <td class="market-value" data-code="3406"></td>
                </tr>
                <tr>
                    <td><a href="fetch_stock_twstock.html?stockCode=8996" target="_blank">高力</a></td>
                    <td><a href="fetch_stock_twstock.html?stockCode=8996" target="_blank">8996</a></td>
                    <td>0905 質借中</td>
                    <td class="price-cell" data-code="8996"></td>
                    <td>2000</td>
                    <td class="market-value" data-code="8996"></td>
                </tr>
                <tr>
                    <td><a href="fetch_stock_twstock.html?stockCode=3443" target="_blank">創意</a></td>
                    <td><a href="fetch_stock_twstock.html?stockCode=3443" target="_blank">3443</a></td>
                    <td>1023 質借中</td>
                    <td class="price-cell" data-code="3443"></td>
                    <td>1000</td>
                    <td class="market-value" data-code="3443"></td>
                </tr>
                <tr>
                    <td><a href="fetch_stock_twstock.html?stockCode=1503" target="_blank">士電</a></td>
                    <td><a href="fetch_stock_twstock.html?stockCode=1503" target="_blank">1503</a></td>
                    <td>1023 質借中</td>
                    <td class="price-cell" data-code="1503"></td>
                    <td>3000</td>
                    <td class="market-value" data-code="1503"></td>
                </tr>
                <tr>
                    <td><a href="fetch_stock_twstock.html?stockCode=3324" target="_blank">中興電</a></td>
                    <td><a href="fetch_stock_twstock.html?stockCode=3324" target="_blank">3324</a></td>
                    <td>1023 質借中</td>
                    <td class="price-cell" data-code="3324"></td>
                    <td>2000</td>
                    <td class="market-value" data-code="3324"></td>
                </tr>
                <tr>
                    <td><a href="fetch_stock_twstock.html?stockCode=3017" target="_blank">奇鋐</a></td>
                    <td><a href="fetch_stock_twstock.html?stockCode=3017" target="_blank">3017</a></td>
                    <td>1023 質借中</td>
                    <td class="price-cell" data-code="3017"></td>
                    <td>2000</td>
                    <td class="market-value" data-code="3017"></td>
                </tr>
            </tbody>
        </table>

        <p>總借款金額: 6,700,000 元</p>
        <button id="calculateButton" class="btn btn-primary">計算總維持率</button>
        <button id="recalculateButton" class="btn btn-secondary">重新計算維持率</button>

        <!-- Modal -->
        <div class="modal fade" id="loadingModal" tabindex="-1" role="dialog" aria-labelledby="loadingModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="loadingModalLabel">查詢中...</h5>
                    </div>
                    <div class="modal-body">
                        <p>請稍候，正在查詢股價...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4" id="result">
            <!-- 這裡將顯示計算結果 -->
        </div>
    </div>

    <script>
        let stockData; // 定义一个全局变量来存储股票数据
        let apiData; // 定义一个全局变量来存储从 API 获取的数据

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('calculateButton').addEventListener('click', function() {
                const loanAmount = 6700000; // 固定借款金額
                stockData = [ // 存储股票数据
                    { code: '3661', shares: 2000 },
                    { code: '6531', shares: 4000 },
                    { code: '3548', shares: 4000 },
                    { code: '3406', shares: 2000 },
                    { code: '8996', shares: 2000 },
                    { code: '3443', shares: 1000 },
                    { code: '1503', shares: 3000 },
                    { code: '1513', shares: 6000 },
                    { code: '3324', shares: 2000 },
                    { code: '3017', shares: 2000 }
                ];

                // 显示查询中模态框
                $('#loadingModal').modal('show');
                document.getElementById('result').innerHTML = ''; // 清空结果区域

                // 使用完整的 Python 路径调用脚本
                const command = `/usr/local/bin/python /Users/garylin/Projects-Cursor/stock/fetch_stock_twstock.py ${stockData.map(stock => stock.code).join(' ')}`;
                fetch('maintenance_rate_exec.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ command: command, loanAmount: loanAmount })
                })
                .then(response => response.json())
                .then(data => {
                    apiData = data; // 将从 API 获取的数据存储到全局变量中
                    let totalMarketValue = 0; // 初始化总市值
                    const today = new Date().toISOString().split('T')[0].replace(/-/g, '/'); // 获取今天的日期
                    document.getElementById('priceHeader').textContent = `${today} 股價`; // 更新表头日期

                    for (const stock of stockData) {
                        const priceFromAPI = apiData.prices[stock.code]; // 从 API 获取的股价
                        const priceCell = document.querySelector(`.price-cell[data-code="${stock.code}"]`);
                        
                        // 检查用户输入的股价
                        const inputPrice = document.getElementById(`input-${stock.code}`);
                        const userInputPrice = inputPrice && inputPrice.value ? parseFloat(inputPrice.value) : null; // 用户输入的股价

                        // 使用用户输入的股价，如果没有输入则使用 API 获取的股价
                        const price = userInputPrice !== null ? userInputPrice : priceFromAPI.price;

                        if (priceCell) {
                            if (priceFromAPI === null || priceFromAPI.price === null) {
                                // 如果股价未获取，显示输入框
                                priceCell.innerHTML = `<input type="number" id="input-${stock.code}" placeholder="輸入股價" />`;
                            } else {
                                // 否则显示获取到的股价
                                priceCell.textContent = priceFromAPI.price; // 直接显示获取到的股价
                            }
                        }

                        // 计算市值并填充
                        const marketValueCell = document.querySelector(`.market-value[data-code="${stock.code}"]`);
                        if (marketValueCell) {
                            const marketValue = !isNaN(price) ? price * stock.shares : 0;
                            marketValueCell.textContent = marketValue.toLocaleString(); // 填充市值
                            totalMarketValue += marketValue; // 累加总市值
                        }
                    }

                    // 计算总维持率
                    if (loanAmount > 0) {
                        const totalMaintenanceRate = (totalMarketValue / loanAmount) * 100;
                        document.getElementById('result').innerHTML = `<h2>總維持率: ${totalMaintenanceRate.toFixed(2)}%</h2>`;
                    } else {
                        document.getElementById('result').innerHTML = "<h3>借款金額無效</h3>";
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('result').innerHTML = "<h3>無法獲取數據</h3>";
                })
                .finally(() => {
                    // 隐藏查询模态框
                    $('#loadingModal').modal('hide');
                });
            });

            document.getElementById('recalculateButton').addEventListener('click', function() {
                const loanAmount = 6700000; // 固定借款金額
                let totalMarketValue = 0; // 初始化总市值

                for (const stock of stockData) {
                    const inputPrice = document.getElementById(`input-${stock.code}`);
                    const userInputPrice = inputPrice && inputPrice.value ? parseFloat(inputPrice.value) : null; // 用户输入的股价

                    // 使用用户输入的股价，如果没有输入则使用 API 获取的股价
                    const price = userInputPrice !== null ? userInputPrice : (apiData && apiData.prices[stock.code]) || 0; // 从 apiData 获取股价，如果没有则为 0

                    // 更新表格中的股价显示
                    const priceCell = document.querySelector(`.price-cell[data-code="${stock.code}"]`);
                    if (priceCell) {
                        if (userInputPrice !== null) {
                            // 如果有用户输入的股价，显示输入框
                            priceCell.innerHTML = `<input type="number" id="input-${stock.code}" value="${userInputPrice}" placeholder="輸入股價" />`;
                        } else {
                            // 否则显示获取到的股价
                            priceCell.textContent = price.price; // 直接显示获取到的股价
                        }
                    }

                    // 计算市值并累加
                    let marketValue;

                    // 检查 price 的类型
                    if (typeof price === 'object' && price !== null && 'price' in price) {
                        // 如果 price 是对象且包含 price 属性，则使用该属性的值
                        marketValue = price.price * stock.shares;
                    } else if (typeof price === 'number') {
                        // 如果 price 是数值，则直接使用
                        marketValue = price * stock.shares;
                    } else {
                        // 如果 price 既不是对象也不是数值，则设置为 0
                        marketValue = 0;
                    }

                    // 累加总市值
                    totalMarketValue += marketValue; // 累加总市值

                    // 更新市值显示
                    const marketValueCell = document.querySelector(`.market-value[data-code="${stock.code}"]`);
                    if (marketValueCell) {
                        marketValueCell.textContent = marketValue.toLocaleString(); // 填充市值
                    }
                }

                // 计算总维持率
                if (loanAmount > 0) {
                    const totalMaintenanceRate = (totalMarketValue / loanAmount) * 100;
                    document.getElementById('result').innerHTML = `<h2>總維持率: ${totalMaintenanceRate.toFixed(2)}%</h2>`;
                } else {
                    document.getElementById('result').innerHTML = "<h3>借款金額無效</h3>";
                }
            });
        });
    </script>

    <!-- Bootstrap JS (需要在页面底部引入) -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
