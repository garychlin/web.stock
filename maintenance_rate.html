<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>維持率計算</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        /* 自定義樣式 */
        .modal-body {
            text-align: center;
        }
        /* 設置鏈接顏色為黑色 */
        a {
            color: black; /* 設置鏈接顏色為黑色 */
            text-decoration: none; /* 可選：去掉下划線 */
        }
        a:hover {
            text-decoration: underline; /* 可選：鼠標懸停時顯示下划線 */
        }
    </style>
</head>
<body>
    <?php include 'navigator.html'; ?>
    <?php include 'maintenance_stocks.php'; ?>
    
    <div class="container mt-5">
        <h1>股票維持率計算</h1>

        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th>股票</th>
                    <th>代號</th>
                    <th>狀態</th>
                    <th id="priceHeader">股價</th>
                    <th>股數</th>
                    <th>市值</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($stocks as $stock): ?>
                <tr>
                    <td><a href="fetch_stock_twstock.html?stockCode=<?= $stock['code'] ?>" target="_blank"><?= $stock['name'] ?></a></td>
                    <td><a href="fetch_stock_twstock.html?stockCode=<?= $stock['code'] ?>" target="_blank"><?= $stock['code'] ?></a></td>
                    <td><?= $stock['status'] ?></td>
                    <td class="price-cell" data-code="<?= $stock['code'] ?>"></td>
                    <td><?= $stock['shares'] ?></td>
                    <td class="market-value" data-code="<?= $stock['code'] ?>"></td>
                </tr>
                <?php endforeach; ?>
            </tbody>
        </table>

        <p>總借款金額: <span id="loanAmountDisplay"><?= $loanAmount ?></span> 元</p>
        <button id="calculateButton" class="btn btn-primary">計算總維持率</button>
        <button id="recalculateButton" class="btn btn-secondary">重新計算維持率</button>

        <!-- Modal -->
        <div class="modal fade" id="loadingModal" tabindex="-1" role="dialog" aria-labelledby="loadingModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="loadingModalLabel">查詢中...</h5>
                    </div>
                    <div class="modal-body">
                        <p>請稍候，正在查詢股價...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4" id="result">
            <!-- 這裡將顯示計算結果 -->
        </div>
    </div>

    <script>
        const loanAmount = <?= $loanAmount ?>; // 借款金額變數
        let stockData = <?= json_encode(array_column($stocks, 'code')) ?>; // 將股票代號傳遞給 JavaScript
        let apiData; // 定義一個全局變量來存儲從 API 獲取的數據

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('calculateButton').addEventListener('click', function() {
                // 顯示查詢中模態框
                $('#loadingModal').modal('show');
                document.getElementById('result').innerHTML = ''; // 清空結果區域

                // 使用股票代號生成命令
                const command = `/usr/local/bin/python /Users/garylin/Projects-Cursor/stock/fetch_stock_twstock.py ${stockData.join(',')}`;
                fetch('maintenance_rate_exec.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ command: command, loanAmount: loanAmount })
                })
                .then(response => response.json())
                .then(data => {
                    apiData = data; // 將從 API 獲取的數據存儲到全局變量中
                    let totalMarketValue = 0; // 初始化總市值
                    const today = new Date().toISOString().split('T')[0].replace(/-/g, '/'); // 獲取今天的日期
                    document.getElementById('priceHeader').textContent = `${today} 股價`; // 更新表頭日期

                    for (const stock of stockData) {
                        const priceFromAPI = apiData.prices[stock]; // 從 API 獲取的股價
                        const priceCell = document.querySelector(`.price-cell[data-code="${stock}"]`);

                        if (priceCell) {
                            if (priceFromAPI === null || priceFromAPI.price === null) {
                                // 如果股價未獲取，顯示輸入框
                                priceCell.innerHTML = `<input type="number" id="input-${stock}" placeholder="輸入股價" />`;
                            } else {
                                // 否則顯示獲取到的股價
                                priceCell.textContent = priceFromAPI.price; // 直接顯示獲取到的股價
                            }
                        }

                        // 計算市值並填充
                        const marketValueCell = document.querySelector(`.market-value[data-code="${stock}"]`);
                        if (marketValueCell) {
                            const marketValue = priceFromAPI.price * <?= json_encode($stocks[array_search($stock, $stocks)]['shares']) ?>; // 使用 shares 字段
                            marketValueCell.textContent = marketValue.toLocaleString(); // 填充市值
                            totalMarketValue += marketValue; // 累加總市值
                        }
                    }

                    // 計算總維持率
                    if (loanAmount > 0) {
                        const totalMaintenanceRate = (totalMarketValue / loanAmount) * 100;
                        document.getElementById('result').innerHTML = `<h2>總維持率: ${totalMaintenanceRate.toFixed(2)}%</h2>`;
                    } else {
                        document.getElementById('result').innerHTML = "<h3>借款金額無效</h3>";
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('result').innerHTML = "<h3>無法獲取數據</h3>";
                })
                .finally(() => {
                    // 隱藏查詢模態框
                    $('#loadingModal').modal('hide');
                });
            });

            document.getElementById('recalculateButton').addEventListener('click', function() {
                // 只更新市值和維持率
                let totalMarketValue = 0; // 初始化總市值
                const loanAmount = 6700000; // 固定借款金額

                for (const stock of stockData) {
                    const priceCell = document.querySelector(`.price-cell[data-code="${stock}"] input`);
                    const marketValueCell = document.querySelector(`.market-value[data-code="${stock}"]`);

                    // 獲取用戶輸入的股價
                    const userInputPrice = priceCell ? parseFloat(priceCell.value) : null; // 如果沒有輸入則為 null
                    const shares = <?= json_encode(array_column($stocks, 'shares')) ?>[stockData.indexOf(stock)]; // 獲取對應的股數

                    // 直接使用用戶輸入的股價或從 API 獲取的股價
                    const stockPrice = userInputPrice !== null 
                        ? userInputPrice 
                        : (marketValueCell 
                            ? parseFloat(marketValueCell.textContent.replace(/,/g, '').trim()) / shares 
                            : 0); // 如果沒有輸入，使用之前的股價
                    
                    // 確保股價有效
                    if (isNaN(stockPrice) || stockPrice <= 0) {
                        console.error(`Invalid stock price for ${stock}: ${stockPrice}`);
                        continue; // 跳過此股票的計算
                    }

                    const marketValue = stockPrice * shares; // 使用股數計算市值

                    if (marketValueCell) {
                        marketValueCell.textContent = marketValue.toLocaleString(); // 填充市值
                        totalMarketValue += marketValue; // 累加總市值
                    }
                }


                if (loanAmount > 0) {
                    const totalMaintenanceRate = (totalMarketValue / loanAmount) * 100;
                    document.getElementById('result').innerHTML = `<h2>總維持率: ${totalMaintenanceRate.toFixed(2)}%</h2>`;
                } else {
                    document.getElementById('result').innerHTML = "<h3>借款金額無效</h3>";
                }
            });
        });
    </script>

    <!-- Bootstrap JS (需要在頁面底部引入) -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
