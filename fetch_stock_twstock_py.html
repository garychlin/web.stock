<?php
// 确保从 GET 请求中获取股票代号
$stock_code = isset($_GET['stockCode']) ? $_GET['stockCode'] : '2330'; // 默认为台积电的股票代号

// 使用完整的 Python 路径调用脚本，增加 'history' 参数
$command = escapeshellcmd("/usr/local/bin/python /Users/garylin/Projects-Cursor/stock/fetch_stock_twstock.py history {$stock_code}"); // 使用 python 调用脚本
$output = shell_exec($command); // 执行命令并获取输出

if ($output === null) {
    // 返回错误信息
    header('Content-Type: application/json'); // 设置响应头为 JSON
    echo json_encode(['error' => '无法执行 Python 脚本']);
    exit;
}

// 去除输出中的多余空白字符
$output = trim($output);

// 在处理返回的数据之前添加调试输出
error_log("Python script output: " . $output);

// 处理返回的数据
$data = json_decode($output, true); // 将 JSON 解析为 PHP 数组
if ($data === null) {
    // 返回 JSON 解析错误信息
    header('Content-Type: application/json'); // 设置响应头为 JSON
    echo json_encode(['error' => '无法解析 JSON: ' . json_last_error_msg()]);
    exit;
}

// 输出 JSON 数据
header('Content-Type: application/json'); // 设置响应头为 JSON
echo json_encode($data); // 输出 JSON 数据
?>
